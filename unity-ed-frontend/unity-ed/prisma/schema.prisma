generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ===========================
   PLAYER / RUN LOCAL MODELS
=========================== */

model PlayerProfile {
  playerId         String               @id @map("player_id") @db.Char(36)
  alias            String?              @db.VarChar(50)
  createdAt        DateTime?            @default(now()) @map("created_at") @db.DateTime(0)

  playerProgress   PlayerProgress[]
  playerScores     PlayerScoresPanel[]
  runLocal         RunLocal[]
  students         Student[]

  @@map("playerprofile")
}

model PlayerProgress {
  id          Int            @id @default(autoincrement())
  playerId    String?        @map("player_id") @db.Char(36)
  actNo       Int?           @map("act_no")
  sceneCode   String?        @map("scene_code") @db.VarChar(50)
  checkpoint  String?        @db.VarChar(100)

  playerProfile PlayerProfile? @relation(fields: [playerId], references: [playerId], map: "playerprogress_ibfk_1")

  @@index([playerId], map: "player_id")
  @@map("playerprogress")
}

model PlayerScoresPanel {
  id            Int                     @id @default(autoincrement())
  playerId      String?                 @map("player_id") @db.Char(36)
  trait         PlayerScoresPanelTrait?
  score         Int?
  lastUpdated   DateTime?               @map("last_updated") @db.DateTime(0)

  playerProfile PlayerProfile? @relation(fields: [playerId], references: [playerId], map: "playerscorespanel_ibfk_1")

  @@index([playerId], map: "player_id")
  @@map("playerscorespanel")
}

model RunEventsLocal {
  id         Int       @id @default(autoincrement())
  runId      String?   @map("run_id") @db.Char(36)
  seq        Int?
  sceneCode  String?   @map("scene_code") @db.VarChar(50)
  nodeId     Int?      @map("node_id")
  optionId   Int?      @map("option_id")
  decidedAt  DateTime? @map("decided_at") @db.DateTime(0)
  latencyMs  Int?      @map("latency_ms")

  runLocal   RunLocal? @relation(fields: [runId], references: [runId], map: "runeventslocal_ibfk_1")

  @@index([runId], map: "run_id")
  @@map("runeventslocal")
}

model RunLocal {
  runId            String                 @id @map("run_id") @db.Char(36)
  playerId         String?                @map("player_id") @db.Char(36)
  levelOrAct       Int?                   @map("level_or_act")
  endedAt          DateTime?              @map("ended_at") @db.DateTime(0)
  totalScore       Int?                   @map("total_score")
  uploadStatus     RunLocalUploadStatus   @default(pending) @map("upload_status")
  lastError        String?                @map("last_error") @db.VarChar(200)
  idempotencyKey   String?                @map("idempotency_key") @db.VarChar(50)
  createdAt        DateTime?              @default(now()) @map("created_at") @db.DateTime(0)

  runEventsLocal   RunEventsLocal[]
  playerProfile    PlayerProfile? @relation(fields: [playerId], references: [playerId], map: "runlocal_ibfk_1")
  runTraitScores   RunTraitScoresLocal[]
  uploadQueue      UploadQueue[]

  @@index([playerId], map: "player_id")
  @@map("runlocal")
}

model RunTraitScoresLocal {
  id       Int                       @id @default(autoincrement())
  runId    String?                   @map("run_id") @db.Char(36)
  trait    RunTraitScoresLocalTrait?
  score    Int?

  runLocal RunLocal? @relation(fields: [runId], references: [runId], map: "runtraitscoreslocal_ibfk_1")

  @@index([runId], map: "run_id")
  @@map("runtraitscoreslocal")
}

model UploadQueue {
  queueId     Int                  @id @default(autoincrement()) @map("queue_id")
  runId       String?              @map("run_id") @db.Char(36)
  payloadJson Json?                @map("payload_json")
  status      UploadQueueStatus?   @default(queued)
  retryCount  Int?                 @default(0) @map("retry_count")
  lastError   String?              @map("last_error") @db.VarChar(200)
  createdAt   DateTime?            @default(now()) @map("created_at") @db.DateTime(0)

  runLocal    RunLocal? @relation(fields: [runId], references: [runId], map: "uploadqueue_ibfk_1")

  @@index([runId], map: "run_id")
  @@map("uploadqueue")
}

/* ===========================
        AUTH MODELS
=========================== */

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique(map: "email") @db.VarChar(100)
  password   String    @db.VarChar(255)
  role       UserRole
  createdAt  DateTime? @default(now()) @map("created_at") @db.DateTime(0)

  account        Account[]
  session        Session[]
  taughtStudents Student[] @relation("TeacherStudents")

  @@map("user")
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int     @map("userId")
  type              String? @db.VarChar(255)
  provider          String? @db.VarChar(255)
  providerAccountId String? @map("providerAccountId") @db.VarChar(255)
  refreshToken      String? @map("refresh_token") @db.Text
  accessToken       String? @map("access_token") @db.Text
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type") @db.VarChar(255)
  scope             String? @db.VarChar(255)
  idToken           String? @map("id_token") @db.Text
  sessionState      String? @map("session_state") @db.VarChar(255)

  user              User @relation(fields: [userId], references: [id], map: "account_ibfk_1")

  @@unique([provider, providerAccountId], map: "unique_provider")
  @@index([userId], map: "userId")
  @@map("account")
}

model Session {
  id           Int       @id @default(autoincrement())
  sessionToken String?   @unique(map: "sessionToken") @db.VarChar(255)
  userId       Int?      @map("userId")
  expires      DateTime? @db.DateTime(0)

  user         User?     @relation(fields: [userId], references: [id], map: "session_ibfk_1")

  @@index([userId], map: "userId")
  @@map("session")
}

/* ===========================
      SCHOOL / CLASS / STUDENT
=========================== */

model School {
  id            Int        @id @default(autoincrement())
  name          String     @db.VarChar(100)
  address       String?    @db.VarChar(255)
  contactNumber String?    @map("contact_number") @db.VarChar(20)
  createdAt     DateTime?  @default(now()) @map("created_at") @db.Timestamp(0)

  classes  Class[]
  students Student[]

  @@map("schools")
}

model Class {
  id         Int        @id @default(autoincrement())
  schoolId   Int        @map("school_id")
  className  String     @map("class_name") @db.VarChar(50)
  teacherName String?   @map("teacher_name") @db.VarChar(100)
  createdAt  DateTime?  @default(now()) @map("created_at") @db.Timestamp(0)

  school    School     @relation(fields: [schoolId], references: [id], map: "classes_ibfk_1")
  students  Student[]

  @@index([schoolId], map: "school_id")
  @@map("classes")
}

model Student {
  id        Int       @id @default(autoincrement())
  alias     String    @db.VarChar(100)
  playerId  String?   @map("player_id") @db.Char(36)
  classId   Int?      @map("class_id")
  schoolId  Int?      @map("school_id")
  teacherId Int?      @map("teacher_id")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(0)

  playerProfile PlayerProfile? @relation(fields: [playerId], references: [playerId], map: "students_ibfk_1")
  class         Class?         @relation(fields: [classId], references: [id], map: "students_ibfk_2")
  school        School?        @relation(fields: [schoolId], references: [id], map: "students_ibfk_3")

  teacher       User?          @relation("TeacherStudents", fields: [teacherId], references: [id], map: "students_ibfk_4")

  @@index([classId], map: "classId")
  @@index([playerId], map: "player_id")
  @@index([schoolId], map: "schoolId")
  @@index([teacherId], map: "teacherId")
  @@map("students")
}

/* ===========================
            ENUMS
=========================== */

enum RunTraitScoresLocalTrait {
  Rapport
  Reputation
  Stress
}

enum PlayerScoresPanelTrait {
  Rapport
  Reputation
  Stress
}

enum UploadQueueStatus {
  queued
  uploaded
  failed
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum RunLocalUploadStatus {
  pending
  uploaded
}
